# DevNet Marathon - Topology Visualization
Вариант реализации задания на визуализацию сетевых топологий для Cisco DevNet Марафона.

### Используемый стек:
  - Python3
  - [Nornir](https://nornir.readthedocs.io/en/latest/)
  - [NAPALM](https://napalm.readthedocs.io/en/latest/)
  - [NeXt UI](https://developer.cisco.com/site/neXt/) (JS+HTML5)

### Установка и первичная настройка:
Установите зависимости:
```sh
$ mkdir ~/devnet_marathon_endgame
$ cd ~/devnet_marathon_endgame
$ git clone https://github.com/iDebugAll/devnet_marathon_endgame.git
$ cd devnet_marathon_endgame
$ pip3 install -i requirements.txt
```
Отредактируйте конфигурационные файлы Nornir для доступа на целевую сетевую инфраструктуру.
По умолчанию используется модуль SimpleInventory.
В файле nornir_config.yml необходимо указать используемые файлы хостов и групп.
Файл хостов, используемый по умолчанию, настроен на работу по SSH с сетевой топологией из [Cisco Modeling Labs](https://devnetsandbox.cisco.com/RM/Diagram/Index/685f774a-a5d6-4df5-a324-3774217d0e6b?diagramType=Topology) в Cisco Devnet Sandbox.
Для подключения к Cisco DevNet Sandbox требуется бесплатная регистрация, резервирование и VPN-доступ.

### Использование:
Для синхронизации топологии необходимо запустить скрипт generate_topology.py.
После того, как скрипт завершит работу, необходимо открыть файл main.html.
```
$ python3.7 generate_topology.py 
Изменений в топологии не обнаружено.
Для просмотра топологии откройте файл main.html
```

![sample_topology](/samples/sample_topology.png)

### Возможности и описание работы:

Решение является [кросплатформенным](https://napalm.readthedocs.io/en/latest/support/), интегрируемым и расширяемым.
Скрипт протестирован на IOS, IOS-XE и NX-OS.

Для сбора данных с сетевых устройств используется связка NAPALM+Nornir:
  - NAPALM геттер GET_LLDP_NEIGHBORS_DETAILS (сбор LLDP-соседств);
  - NAPALM геттер GET_FACTS (общие данные об устройстве для вывода в подсказке).

На вход принимается инициализированный инвентори Nornir с:
  - IP-адресами устройств;
  - Аутентификационными данными для этих устройств с правами на чтение.

На выходе генерируется:
  - Файл topology.js c JS объектом топологии для NeXt UI;
  - Файл cached_topology.json с JSON-представлением проанализированной топологии.
  - Консольный вывод с результатами проверки на наличие изменений в топологии.

Файл topology.js перезаписывается при каждом запуске. Версия в репозитории для ознакомления содержит результат обработки топологии из [Cisco Modeling Labs](https://devnetsandbox.cisco.com/RM/Diagram/Index/685f774a-a5d6-4df5-a324-3774217d0e6b?diagramType=Topology) в Cisco DevNet Sandbox.

Реализована базовая обработка возможных ошибок и нормализация данных.
Попытка сбора данных по умолчанию осуществляется со всех устройст в инвентори.
В случае ошибок в получении данных, отсутствия LLDP соседств, прав и т.п. на
каком-либо из хостов, он включается в топологию с именем из инвентори без связей.

Поддерживается сценарий с отсутствующими LLDP-соседствами (internet-rtr01.virl.info на примере выше).
Поддерживается сценарий с отсутствием доступа на одиночные промежуточные устройства (core-rtr01.devnet.lab и core-rtr02.devnet.lab на примере выше) при условии запущенного на них LLDP.

Типы пиктограмм выбираются автоматически по следующей логике в порядке убывания приоритета:
  - На основании LLDP capabilities, полученных от соседей.
  - На основании модели устройства, если с этого устройства собирались данные, и модель имеется в выводе GET_FACTS.
  - Значение по умолчанию 'unknown' (пиктограмма вопросительного знака).

Для визуализации используется набор инструментов NeXt UI. Получаемая в результате страница main.html содержит интерактивную форму с визуализацией проанализированного участка сети.

Пиктограммы устройств могут перемещаться мышью в произвольном направлении с адаптивной отрисовкой линков. Поддерживается выделение и групповое перемещение.
При наведении указателя на элемент топологии автоматически затемняются все несвязанные с ним ноды и линки.

По левому клику мыши на устройство выводится меню со справочной информацией:
![node_details](/samples/sample_node_details.png)

Серийный номер и модель указываются для устройств на основании вывода GET_FACTS там, где это возможно.
Для устройств, на которые имеется доступ, может быть добавлена произвольная информация.
Аналогично для линков:

![node_details](/samples/sample_link_details.png)

При каждом запуске скрипта generate_topology.py выполняется анализ изменений топологии.
Полученные с устройств детали топологии записываются, помимо прочего, в файл cached_topology.json
Данный файл считывается при старте и сравнивается с текущим полученным от устройств состоянием.
В результате данные о добавленных и удаленных в топологии устройствах и линках выводится в консоль, а в файл diff_topology.js записывается объединенная версия двух топологий с расширенными атрибутами для визуализации изменений. Файл с визуализированными изменениями топологии можно посмотреть, открыв файл diff_page.html.

Вывод из консоли:

```
$ python3.7 generate_topology.py 
Для просмотра топологии откройте файл main.html

Обнаружены изменения в топологии:

^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
Новые сетевые устройства:
vvvvvvvvvvvvvvvvvvvvvvvvvvvvv
Имя устройства: dist-rtr01.devnet.lab

^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
Удаленные сетевые устройства:
vvvvvvvvvvvvvvvvvvvvvvvvvvvvv
Имя устройства: edge-sw01.devnet.lab

^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
Новые соединения между устройствами:
vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
От dist-rtr01.devnet.lab(Gi3) к core-rtr02.devnet.lab(Gi0/0/0/2)
От dist-rtr01.devnet.lab(Gi4) к dist-sw01.devnet.lab(Eth1/3)
От dist-rtr01.devnet.lab(Gi6) к dist-rtr02.devnet.lab(Gi6)
От dist-rtr01.devnet.lab(Gi5) к dist-sw02.devnet.lab(Eth1/3)
От dist-rtr01.devnet.lab(Gi2) к core-rtr01.devnet.lab(Gi0/0/0/2)

^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
Удаленные соединения между устройствами:
vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
От edge-sw01.devnet.lab(Gi0/2) к core-rtr01.devnet.lab(Gi0/0/0/1)
От edge-sw01.devnet.lab(Gi0/3) к core-rtr02.devnet.lab(Gi0/0/0/1)

Для просмотра топологии с визуализацией изменений откройте файл diff_page.html
```

И отображение файла diff.html:

![sample_diff](/samples/sample_diff.png)

Отображение удаленных и новых элементов интуитивно понятно. :)
